import os
import requests
import telebot
from telebot import types
from deep_translator import GoogleTranslator
import random
import string
import google.generativeai as genai  
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton
from datetime import datetime
import logging
from langdetect import detect

# Ø¥Ø¹Ø¯Ø§Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
logging.basicConfig(filename='bot_errors.log', level=logging.ERROR, format='%(asctime)s - %(message)s')

# Ø¶Ø¹ Ù‡Ù†Ø§ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ (Ø§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©)
API_TOKEN = 'YOUR_TELEGRAM_BOT_TOKEN'         # ØªÙˆÙƒÙ† Ø¨ÙˆØª ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
API_GEMINI = 'YOUR_GEMINI_API_KEY'              # Ù…ÙØªØ§Ø­ API Ø§Ù„Ø®Ø§Øµ Ø¨Ù€ Gemini (Ø¥Ù† ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù…Ù‡)
ADMIN_ID = 123456789                           # Ø±Ù‚Ù… Ù…Ø¹Ø±Ù Ø§Ù„Ø£Ø¯Ù…Ù†

bot = telebot.TeleBot(API_TOKEN)

# Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
USERS_FILE = 'users.txt'
if not os.path.exists(USERS_FILE):
    open(USERS_FILE, 'w').close()

# Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
banned_users = set()
admins = {ADMIN_ID}     # Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù‡Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
users = {}
broadcast_list = []
user_sessions = {}

# Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØµÙˆØ±
IMAGE_FOLDER = "images"
os.makedirs(IMAGE_FOLDER, exist_ok=True)

# Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ¥Ø¹Ù„Ø§Ù… Ø§Ù„Ø£Ø¯Ù…Ù†
def save_user(user_id, username, full_name):
    user_id_str = str(user_id)
    new_user = False
    with open(USERS_FILE, 'r') as f:
        users_list = f.read().splitlines()
    if user_id_str not in users_list:
        new_user = True
        with open(USERS_FILE, 'a') as f:
            f.write(user_id_str + '\n')
    if new_user:
        with open(USERS_FILE, 'r') as f:
            total_users = len(f.read().splitlines())
        try:
            bot.send_message(
                ADMIN_ID,
                f"""ğŸ‘¾ Ø¯Ø®Ù„ Ø´Ø®Øµ Ø¬Ø¯ÙŠØ¯:
- Ø§Ù„Ø§Ø³Ù…: {full_name or 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}
- Ø§Ù„Ù…Ø¹Ø±Ù: @{username if username else 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}
- ID: {user_id}
â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: {total_users}"""
            )
        except Exception as e:
            logging.error(f"Error sending new user info: {e}")

# Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
def get_statistics():
    if not os.path.exists(USERS_FILE) or os.stat(USERS_FILE).st_size == 0:
        return "ğŸš« Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†."
    with open(USERS_FILE, 'r') as f:
        users_list = f.read().splitlines()
    total_users = len(users_list)
    last_users = users_list[-10:]
    last_users_str = "\n".join([f"ID: {uid}" for uid in last_users])
    return f"ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {total_users}\n\nğŸ“Œ Ø¢Ø®Ø± 10 Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:\n{last_users_str}"

# Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯Ù…Ù† (Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…)
def get_admin_menu():
    markup = InlineKeyboardMarkup(row_width=1)
    markup.add(InlineKeyboardButton("ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", callback_data="manage_users"))
    markup.add(InlineKeyboardButton("ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", callback_data="statistics"))
    markup.add(InlineKeyboardButton("ğŸ“¢ Ø§Ù„Ø¥Ø°Ø§Ø¹Ø©", callback_data="broadcast"))
    markup.add(InlineKeyboardButton("ğŸ“¢ Ø¥Ø°Ø§Ø¹Ø© Ø¨Ø§Ù„ØªØ«Ø¨ÙŠØª", callback_data="broadcast_pin"))
    return markup

def get_manage_users_menu():
    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("ğŸš« Ø­Ø¶Ø± Ù…Ø³ØªØ®Ø¯Ù…", callback_data="ban_user"))
    markup.add(InlineKeyboardButton("ğŸ”“ ÙÙƒ Ø§Ù„Ø­Ø¸Ø±", callback_data="unban_user"))
    markup.add(InlineKeyboardButton("â• Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ù…Ù†", callback_data="add_admin"))
    markup.add(InlineKeyboardButton("â– Ø­Ø°Ù Ø£Ø¯Ù…Ù†", callback_data="remove_admin"))
    return markup

# Ø£Ù…Ø± /start
@bot.message_handler(commands=['start'])
def send_welcome(message):
    user_id = message.from_user.id
    username = message.from_user.username
    save_user(user_id, username, message.from_user.first_name)

    if user_id in banned_users:
        bot.send_message(user_id, "âŒ Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª.")
        return

    markup = InlineKeyboardMarkup()
    markup.add(InlineKeyboardButton("Ø§Ù„Ù…Ø·ÙˆØ±", url="https://www.facebook.com/time.bird.boykta))
    markup.add(InlineKeyboardButton("Ø¨ÙˆØª Ø¯ÙŠÙ†ÙŠ", url="https://t.me/boytaabot))

    bot.send_message(
        message.chat.id,
        """```âœÙ…Ø§ÙŠÙƒÙŠ```

*â€¢ Ø£Ù‡Ù„Ø§ Ø¨Ùƒ Ø¹Ø²ÙŠØ²ÙŠ*  
â€¢ ÙÙŠ Ø¨ÙˆØª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ğŸ¤–  

â€¢ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª:
- `Ø¨ÙˆØªÙŠ + Ø³Ø¤Ø§Ù„Ùƒ` â†’ Ù„Ù„ØªØ­Ø¯Ø« Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ  
- `/image + ÙˆØµÙ` â†’ Ù„Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø©  
- `/Write + Ù†Øµ` â†’ Ù„Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ  
- `/clear` â†’ Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©""",
        reply_markup=markup,
        parse_mode="Markdown"
    )

# Ø£Ù…Ø± /clear Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
@bot.message_handler(commands=['clear'])
def close_ai_chat_command(message):
    user_id = message.chat.id
    if user_id in user_sessions:
        del user_sessions[user_id]
        bot.send_message(user_id, "âŒ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.")

# Ø£Ù…Ø± Ø§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (ÙŠØ¨Ø¯Ø£ Ø¨Ù€ "Ø¨ÙˆØªÙŠ")
@bot.message_handler(func=lambda message: message.text and message.text.lower().startswith("Ø¨ÙˆØªÙŠ"))
def ai_chat_command(message):
    user_id = message.chat.id
    user_content = message.text.replace('Ø¨ÙˆØªÙŠ', '').strip()

    if not user_content:
        bot.send_message(user_id, "âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø¨Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø± `Ø¨ÙˆØªÙŠ`")
        return

    try:
        language = detect(user_content)
        # ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
        translated_user_content_en = GoogleTranslator(source=language, target='en').translate(user_content) if language == 'ar' else user_content
    except Exception as e:
        logging.error(f"Error detecting language: {e}")
        translated_user_content_en = user_content

    genai.configure(api_key=API_GEMINI)
    if user_id not in user_sessions:
        try:
            user_sessions[user_id] = genai.GenerativeModel(model_name="gemini-1.5-flash").start_chat(history=[])
        except Exception as e:
            logging.error(f"Error starting chat session: {e}")
            bot.send_message(user_id, "âŒ Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.")
            return

    chat_session = user_sessions[user_id]

    try:
        bot.send_chat_action(user_id, 'typing')
        response = chat_session.send_message(translated_user_content_en)
        translated_response_ar = GoogleTranslator(source='en', target='ar').translate(response.text)
        bot.send_message(user_id, f"*ğŸ¤– Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ:*\n{translated_response_ar}", parse_mode="Markdown")
    except Exception as e:
        logging.error(f"Error in AI chat: {e}")
        bot.send_message(user_id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ.")

# Ø£Ù…Ø± /image Ù„Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØµÙ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø®Ø§Ø±Ø¬ÙŠ (Ù…Ø«Ù„Ø§Ù‹ DeepAI)
@bot.message_handler(commands=['image'])
def create_image_with_description(message):
    description = message.text.replace('/image', '').strip()
    if not description:
        bot.send_message(message.chat.id, "âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ù„Ù„ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ `/image`")
        return

    bot.send_message(message.chat.id, f"ğŸ¨ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ø¨ÙˆØµÙ: {description}")
    try:
        translated_description = GoogleTranslator(source='auto', target='en').translate(description)
        # Ù…Ø«Ø§Ù„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… DeepAI Text2Img API (Ø§Ø³ØªØ¨Ø¯Ù„ YOUR_DEEPAI_API_KEY Ø¨Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ØµØ­ÙŠØ­)
        response = requests.post(
            "https://api.deepai.org/api/text2img",
            data={'text': translated_description},
            headers={'api-key': 'YOUR_DEEPAI_API_KEY'}
        )
        image_url = response.json().get("output_url")
        if image_url:
            bot.send_photo(message.chat.id, image_url, caption="âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­.")
        else:
            bot.send_message(message.chat.id, "âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø©.")
    except Exception as e:
        logging.error(f"Error creating image: {e}")
        bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©.")

# Ø£Ù…Ø± /Write Ù„Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Øµ
@bot.message_handler(commands=['Write'])
def create_text_image(message):
    text = message.text.replace('/Write', '').strip()
    if not text:
        bot.send_message(message.chat.id, "âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ Ø¨Ø¹Ø¯ `/Write`")
        return

    bot.send_message(message.chat.id, f"ğŸ“ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ù„Ù„Ù†Øµ: {text}")
    try:
        # ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
        if any('\u0600' <= c <= '\u06FF' for c in text):
            text = GoogleTranslator(source='ar', target='en').translate(text)
        img_url = f"https://apis.xditya.me/write?text={text}"
        response = requests.get(img_url)
        if response.status_code == 200:
            image_path = os.path.join(IMAGE_FOLDER, "text_image.jpg")
            with open(image_path, "wb") as f:
                f.write(response.content)
            with open(image_path, "rb") as photo:
                bot.send_photo(message.chat.id, photo, caption="âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø§Ù„Ù†Øµ Ø¨Ù†Ø¬Ø§Ø­.", parse_mode="Markdown")
            os.remove(image_path)
        else:
            bot.send_message(message.chat.id, "âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø§Ù„Ù†Øµ.")
    except Exception as e:
        logging.error(f"Error creating text image: {e}")
        bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø§Ù„Ù†Øµ.")

# Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø¯Ù…Ù†
@bot.message_handler(commands=['admin'])
def admin_start(message):
    user_id = message.from_user.id
    if user_id in banned_users:
        bot.send_message(user_id, "âŒ Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª.")
        return

    if user_id not in users:
        users[user_id] = {"username": message.from_user.username, "joined": datetime.now()}

    if user_id in admins:
        bot.send_message(user_id, "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…", reply_markup=get_admin_menu())
    else:
        bot.send_message(user_id, "âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†.")

# Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
@bot.callback_query_handler(func=lambda call: True)
def callback_query(call):
    user_id = call.from_user.id
    if user_id in banned_users:
        bot.send_message(user_id, "âŒ Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª.")
        return

    if call.data == "manage_users":
        if user_id in admins:
            bot.send_message(user_id, "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", reply_markup=get_manage_users_menu())
    elif call.data == "ban_user":
        if user_id in admins:
            msg = bot.send_message(user_id, "Ø£Ø±Ø³Ù„ ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø­Ø¸Ø±Ù‡:")
            bot.register_next_step_handler(msg, ban_user)
    elif call.data == "unban_user":
        if user_id in admins:
            msg = bot.send_message(user_id, "Ø£Ø±Ø³Ù„ ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ÙÙƒ Ø­Ø¸Ø±Ù‡:")
            bot.register_next_step_handler(msg, unban_user)
    elif call.data == "add_admin":
        if user_id in admins:
            msg = bot.send_message(user_id, "Ø£Ø±Ø³Ù„ ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡ ÙƒØ£Ø¯Ù…Ù†:")
            bot.register_next_step_handler(msg, add_admin)
    elif call.data == "remove_admin":
        if user_id in admins:
            msg = bot.send_message(user_id, "Ø£Ø±Ø³Ù„ ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†:")
            bot.register_next_step_handler(msg, remove_admin)
    elif call.data == "statistics":
        if user_id in admins:
            stats = get_statistics()
            bot.send_message(user_id, stats)
    elif call.data == "broadcast":
        if user_id in admins:
            msg = bot.send_message(user_id, "âœ‰ï¸ Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:")
            bot.register_next_step_handler(msg, send_broadcast)
    elif call.data == "broadcast_pin":
        if user_id in admins:
            msg = bot.send_message(user_id, "ğŸ“Œ Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ Ø§Ù„ØªØ«Ø¨ÙŠØª:")
            bot.register_next_step_handler(msg, send_broadcast, pin=True)

def ban_user(message):
    try:
        user_id_to_ban = int(message.text)
        banned_users.add(user_id_to_ban)
        bot.send_message(message.chat.id, f"âœ… ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_id_to_ban}")
    except Exception as e:
        logging.error(f"Error banning user: {e}")
        bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….")

def unban_user(message):
    try:
        user_id_to_unban = int(message.text)
        banned_users.discard(user_id_to_unban)
        bot.send_message(message.chat.id, f"âœ… ØªÙ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø± Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_id_to_unban}")
    except Exception as e:
        logging.error(f"Error unbanning user: {e}")
        bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙÙƒ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….")

def add_admin(message):
    try:
        new_admin_id = int(message.text)
        admins.add(new_admin_id)
        bot.send_message(message.chat.id, f"âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¯Ù…Ù†: {new_admin_id}")
    except Exception as e:
        logging.error(f"Error adding admin: {e}")
        bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¯Ù…Ù†.")

def remove_admin(message):
    try:
        admin_id_to_remove = int(message.text)
        admins.discard(admin_id_to_remove)
        bot.send_message(message.chat.id, f"âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø£Ø¯Ù…Ù†: {admin_id_to_remove}")
    except Exception as e:
        logging.error(f"Error removing admin: {e}")
        bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø£Ø¯Ù…Ù†.")

def send_broadcast(message, pin=False):
    try:
        with open(USERS_FILE, 'r') as f:
            all_users = f.read().splitlines()
        for uid in all_users:
            try:
                sent_message = bot.send_message(uid, message.text)
                if pin:
                    bot.pin_chat_message(uid, sent_message.message_id)
            except Exception as ex:
                logging.error(f"Error broadcasting to {uid}: {ex}")
        bot.send_message(message.chat.id, "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!")
    except Exception as e:
        logging.error(f"Error in broadcast: {e}")
        bot.send_message(message.chat.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø°Ø§Ø¹Ø©.")

# Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ Ø§Ù„Ø¨ÙˆØª
bot.polling()
